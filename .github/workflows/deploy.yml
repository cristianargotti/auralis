# =============================================================================
# AURALIS ‚Äî Auto-Deploy Pipeline
# =============================================================================
# Push to main ‚Üí SSH to EC2 ‚Üí git pull ‚Üí docker compose rebuild.
# Zero-effort deploys. Just push and go.
# =============================================================================
name: üöÄ Deploy

on:
  push:
    branches: [main]
    paths:
      - "auralis/**"
      - "web/**"
      - "Dockerfile.*"
      - "docker-compose*.yml"
      - "Caddyfile"
      - "pyproject.toml"
      - "uv.lock"
  workflow_dispatch:

concurrency:
  group: deploy
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ÔøΩ Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            cd ~/auralis

            echo "ÔøΩ Pulling latest code..."
            git pull origin main

            echo "üèóÔ∏è Rebuilding containers..."
            docker compose up -d --build

            echo "‚úÖ Deploy complete!"
            docker compose ps
