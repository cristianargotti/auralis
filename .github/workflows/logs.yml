name: ðŸ“‹ Server Logs

on:
  workflow_dispatch:
    inputs:
      lines:
        description: "Number of log lines"
        required: false
        default: "150"
      container:
        description: "Container name"
        required: false
        default: "auralis-api-1"

env:
  SG_ID: sg-0e99c64ba4d5840d6
  AWS_REGION: us-east-1

jobs:
  logs:
    name: Fetch Logs
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: ðŸ”‘ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸŒ Open SSH
        run: |
          RUNNER_IP=$(curl -s https://checkip.amazonaws.com)
          echo "RUNNER_IP=$RUNNER_IP" >> $GITHUB_ENV
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ env.SG_ID }} \
            --protocol tcp --port 22 \
            --cidr "${RUNNER_IP}/32" \
            --tag-specifications 'ResourceType=security-group-rule,Tags=[{Key=source,Value=github-actions-logs}]' || true

      - name: ðŸ“‹ Fetch Docker Logs
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "=== Container Status ==="
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" 2>&1
            echo ""
            echo "=== Last ${{ github.event.inputs.lines }} lines of ${{ github.event.inputs.container }} ==="
            docker logs ${{ github.event.inputs.container }} --tail ${{ github.event.inputs.lines }} 2>&1
            echo ""
            echo "=== Disk & Memory ==="
            df -h / | tail -1
            free -h | head -2

            # Optional cleanup
            if [ "${{ github.event.inputs.cleanup }}" = "true" ]; then
              echo ""
              echo "=== ðŸ§¹ Running Cleanup ==="
              docker system prune -f 2>&1
              echo "--- After cleanup ---"
              df -h / | tail -1
            fi

      - name: ðŸ”’ Revoke SSH
        if: always()
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ env.SG_ID }} \
            --protocol tcp --port 22 \
            --cidr "${{ env.RUNNER_IP }}/32" || true
